#!/bin/bash

FORMULA_DIR=$(dirname $0)
ARG0=${0##*/}

if [[ -e $FORMULA_DIR/nova-cloud-controller-common ]] ; then
  . $FORMULA_DIR/nova-cloud-controller-common
else
  echo "ERROR: Could not load nova-cloud-controller-common from $FORMULA_DIR"
fi

function install_hook {
  juju-log "Installing nova packages"
  apt-get -y install python-software-properties || exit 1
  add_ppa
  apt-get update || exit 1
  DEBIAN_FRONTEND=noninteractive apt-get -y \
    install --no-install-recommends $PACKAGES || exit 1
  configure_network_manager $NETWORK_MANAGER

  # setup osapi extensions required for dashboard
  # these are the required middleware extensions as of 12/20/2011
  extensions="nova.api.openstack.compute.contrib.standard_extensions"

  for e in $extensions ; do
    grep -q "^--osapi_compute_extension=$e" "$NOVA_CONF" ||
      echo "--osapi_compute_extension=$e" >>"$NOVA_CONF"
  done

  # Open up the various API endpoints
  # EC2 
  open-port 8774
  # osapi
  open-port 8774
  # volume
  open-port 8776
  # object-store / s3
  open-port 3333

  nova_ctl all stop
}

function amqp_joined {
  # we request a username on the rabbit queue
  # and store it in nova.conf. our response is its IP + PASSWD
  # but we configure that in _changed
  juju-log "amqp_joined: requesting credentials for $RABBIT_USER"
  echo "amqp_joined: requesting credentials for $RABBIT_USER"
  relation-set username=$RABBIT_USER
  relation-set vhost=$RABBIT_VHOST
}

function amqp_changed {
  # server creates our credentials and tells us where
  # to connect.  for now, using default vhost '/'
  RABBIT_HOST=`relation-get private-address`
  RABBIT_PASSWORD=`relation-get password`
  if [[ -z $RABBIT_HOST ]] || \
     [[ -z $RABBIT_PASSWORD ]] ; then 
      echo "amqp_changed: RABBIT_HOST||RABBIT_PASSWORD not set."
      exit 0
  fi
  echo "amqp_changed: Setting rabbit config in nova.conf: $RABBIT_HOST $RABBIT_USER $RABBIT_PASSWORD"
  set_or_update rabbit_host $RABBIT_HOST
  set_or_update rabbit_userid $RABBIT_USER
  set_or_update rabbit_password $RABBIT_PASSWORD
  set_or_update rabbit_virtual_host $RABBIT_VHOST
  nova_ctl all restart
}

function db_joined {
  # tell mysql provider which database we want. it will create it and give us
  # credentials
  juju-log "db_joined: requesting database access to $NOVA_DB for $DB_USER@$HOSTNAME"
  relation-set database=$NOVA_DB
  relation-set username=$DB_USER
  relation-set hostname=`unit-get private-address`
}

function db_changed {
  DB_HOST=`relation-get private-address`
  DB_PASSWORD=`relation-get password`
  if [[ -z $DB_HOST ]] || [[ -z $DB_PASSWORD ]] ; then
    echo "db_changed: DB_HOST || DB_PASSWORD not yet set. Exit 0 and retry"
    exit 0
  fi
  echo "db_changed: Configuring nova.conf for access to $NOVA_DB"
  set_or_update sql_connection "mysql://$DB_USER:$DB_PASSWORD@$DB_HOST/$NOVA_DB"
  nova_ctl all restart
  sleep 1
  /usr/bin/nova-manage db sync
}

function image-service_changed {
  API_SERVER=`relation-get glance-api-server`
  [[ -z $API_SERVER ]] && echo "image-service_changed: Peer not ready?" && exit 0
  set_or_update glance_api_servers $API_SERVER
  set_or_update image_service "nova.image.glance.GlanceImageService"
  nova_ctl all restart
}

function nova-network_joined {
  # this will be moved to its own nova-network formula when the
  # time comes.  for now, tell peer what network manager we are
  # using, and let them configure accordingly. we may want to also
  # take care of assigning non-conflicting IPs to compute nodes
  manager=$(cat $NOVA_CONF | grep network_manager | cut -d= -f2)
  manager=$(echo $manager | sed -e 's/\./ /g' | awk '{ print $4 }')
  relation-set network_manager=$manager ec2_host=$(unit-get private-address)
}

function keystone_joined {
  # we need to get two entries into keystone's catalog, nova + ec2
  # group, them by prepending $service_ to each setting. the keystone
  # charm will assemble settings into corresponding catalog entries
  nova_url="http://$(unit-get private-address):8774/v1.1/\$(tenant_id)s"
  nova_vol_url="http://$(unit-get private-address):8776/v1/\$(tenant_id)s"
  ec2_url="http://$(unit-get private-address):8773/services/Cloud"
  s3_url="http://$(unit-get private-address):3333"
  relation-set nova_service="nova" \
    nova_region="RegionOne" \
    nova_public_url="$nova_url" \
    nova_admin_url="$nova_url" \
    nova_internal_url="$nova_url" \
    nova-volume_service="nova-volume" \
    nova-volume_region="RegionOne" \
    nova-volume_public_url="$nova_vol_url" \
    nova-volume_admin_url="$nova_vol_url" \
    nova-volume_internal_url="$nova_vol_url" \
    ec2_service="ec2" \
    ec2_region="RegionOne" \
    ec2_public_url="$ec2_url" \
    ec2_admin_url="$ec2_url" \
    ec2_internal_url="$ec2_url" \
    s3_service="s3" \
    s3_region="RegionOne" \
    s3_public_url="$s3_url" \
    s3_admin_url="$s3_url" \
    s3_internal_url="$s3_url"
}

function keystone_changed {
  token=$(relation-get admin_token)
  service_port=$(relation-get service_port)
  auth_port=$(relation-get auth_port)
  service_username=$(relation-get service_username)
  service_password=$(relation-get service_password)
  service_tenant=$(relation-get service_tenant)
  [[ -z "$token" ]] || [[ -z "$service_port" ]] || [[ -z "$auth_port" ]] || 
    [[ -z "$service_username" ]] || [[ -z "$service_password" ]] ||
    [[ -z "$service_tenant" ]] && juju-log "keystone_changed: Peer not ready" \
      && exit 0
  [[ "$token" == "-1" ]] &&
    juju-log "keystone_changed: admin token error" && exit 1

  # No need to update paste deploy pipelines, just set a flag in nova.conf
  set_or_update "auth_strategy" "keystone"

  # Update keystone authentication configuration
  keystone_host=$(relation-get private-address)
  set_or_update "keystone_ec2_url" "http://$(relation-get private-address):5000/v2.0/ec2tokens"
  
  if grep -q use_deprecated_auth $NOVA_CONF ; then
    juju-log "keystone_changed: Disabling '--use_deprecated_auth"
    sed -i '/--use_deprecated_auth/d' $NOVA_CONF
  fi

  # update keystone authtoken settings accordingly
  set_or_update "service_host" "$keystone_host" "$API_CONF"
  set_or_update "service_port" "$service_port" "$API_CONF"
  set_or_update "auth_host" "$keystone_host" "$API_CONF"
  set_or_update "auth_port" "$auth_port" "$API_CONF"
  set_or_update "auth_uri" "http://$keystone_host:$service_port/" "$API_CONF"
  set_or_update "admin_token" "$token" "$API_CONF"
  set_or_update "admin_tenant_name" "$service_tenant" "$API_CONF"
  set_or_update "admin_user" "$service_username" "$API_CONF"
  set_or_update "admin_password" "$service_password" "$API_CONF"
  nova_ctl nova-api restart
}

case $ARG0 in
  "start"|"stop") nova_ctl all $ARG0 ;;
  "install") install_hook ;;
  "amqp-relation-joined") amqp_joined ;;
  "amqp-relation-changed") amqp_changed ;;
  "shared-db-relation-joined") db_joined ;;
  "shared-db-relation-changed") db_changed ;;
  "image-service-relation-joined") exit 0 ;;
  "image-service-relation-changed") image-service_changed ;;
  "network-manager-relation-joined") nova-network_joined ;;
  "identity-service-relation-joined") keystone_joined ;;
  "identity-service-relation-changed") keystone_changed ;;
  *) exit 0 ;;
esac
